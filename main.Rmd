---
title: "Forecast Metro train delays in and around NYC"
author: "Nupur Baghel, Shivani Rai"
date: "December 15th, 2020"
output: 
  html_document:
  toc: true
toc_float: true
code_folding: "hide"
code_download: true
---

  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup_13, message=FALSE, include=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(tigris)
library(tidycensus)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RSocrata)
library(caret)
library(osmdata)
library(gifski)
library(gganimate)
library(mapview)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.2),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette3 <- c("#D2FBD4","#92BCAB","#527D82")
palette2 <- c("#6baed6","#08519c")

palette55 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}
q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

```{r install_census_API_key, warning = FALSE, include=FALSE, eval = TRUE}
# Install Census API Key
census_api_key("e79f3706b6d61249968c6ce88794f6f556e5bf3d", overwrite = TRUE)
```

# Import Data

## Kaggle Train Delay dataset
```{r}
# dat_2018_03 = read.csv('archive/2018_03.csv')
# dat_2018_04 = read.csv('archive/2018_04.csv')
# 
# dat <- rbind(dat_2018_03, dat_2018_04)

dat <- read.csv('archive/2018_04.csv')
dat <- dat %>%
  mutate(line = tolower(line),
         scheduled_time =  as_datetime(scheduled_time),
         actual_time = as_datetime(actual_time),
         date = as_date(scheduled_time),
         interval60 = floor_date(ymd_hms(scheduled_time), unit = "hour"),
         dotw =  wday(scheduled_time, label=TRUE),
         week = week(scheduled_time))

unique(dat %>% select(week, date, dotw))
```

```{r}
M <- sapply(dat %>% filter(type == "NJ Transit"), function(x) sum(is.na(x)));
print(M[M>0][[1]])
print(nrow(dat %>% filter(type == "NJ Transit")))

## Amtrak lines do not have scheduled time
M <- sapply(dat %>% filter(type != "NJ Transit"), function(x) sum(is.na(x)));
print(M[M>0][[1]])
print(nrow(dat %>% filter(type != "NJ Transit")))
```

## New Jersey Rail Lines and Rail Stations dataset
```{r}
njlines <- st_read('Passenger_Railroad_Lines_in_NJ-shp/Passenger_Railroad_Lines_in_NJ.shp') %>%
  st_transform('EPSG:2236')
njstations <- st_read('Railroad_Stations_in_NJ-shp/Railroad_Stations_in_NJ.shp') %>%
  st_transform('EPSG:2236')
amtrak <- st_read('Amtrak_Stations-shp/Amtrak_Stations.shp') %>%
  st_transform('EPSG:2236')
```


```{r}
hist(dat$delay_minutes)
```

```{r message=FALSE, warning=FALSE}
subset_amtrak <- st_crop(amtrak, st_bbox(njstations))

ggplot() +
  geom_sf(data = subset_amtrak, color = "black") +
  geom_sf(data = njlines, color = "blue") +
  mapTheme
```

```{r}
# dat - nj (geometry)
# atl. city line - ATLANTIC CITY RAIL LINE
# bergen co. line - BERGEN COUNTY LINE, HUDSON BERGEN LIGHT RAIL
# main line - MAIN LINE
# montclair-boonton - MONTCLAIR BOONTON LINE
# morristown line - MORRIS & ESSEX
# no jersey coast - NORTH JERSEY COAST LINE
# northeast corrdr- NORTHEAST CORRIDOR LINE
# pascack valley - PASCACK VALLEY LINE
# raritan valley - RARITAN VALLEY LINE

# dat - Amtrak

# [1] "regional"                  "amtrak"                   
# [3] "crescent"                  "acela express"            
# [5] "keystone"                  "pennsylvanian"            
# [7] "carolinian"                "silver star  -r"          
# [9] "silver meteor-r"           "vermonter    -r"          
# [11] "amtrak regional"           "palmetto"                 
# [13] "cardinal"                  "bergen co. line "         
# [15] "silver service / palmetto"

# Missing - 6 (gladstone branch), 14 (princeton shuttle)

#amtrak_type_line <- dat %>% filter (type == 'Amtrak')
#dat_amtrak <- subset(dat, type == 'Amtrak')
#dat_amtrak_from <- dat_amtrak %>%
  #left_join(amtrak, by = c('from' = 'CITY2'))
#dat_amtrak_to <- dat_amtrak %>%
  #left_join(amtrak, by = c('to' = 'CITY2'))


dat <- dat %>%
  mutate(new_line_name_geo = case_when(
                  line == 'atl. city line' ~ 'ATLANTIC CITY RAIL LINE',
                  line == 'bergen co. line' ~ 'BERGEN COUNTY LINE',
                  line == 'main line' ~ 'MAIN LINE',
                  line == 'montclair-boonton' ~ 'MONTCLAIR BOONTON LINE',
                  line == 'morristown line' ~ 'MORRIS & ESSEX',
                  line == 'no jersey coast' ~ 'NORTH JERSEY COAST LINE',
                  line == 'northeast corrdr' ~ 'NORTHEAST CORRIDOR LINE',
                  line == 'pascack valley' ~ 'PASCACK VALLEY LINE',
                  line == 'raritan valley' ~ 'RARITAN VALLEY LINE',
                  ))

dat_nj <- subset(dat, type != 'Amtrak') %>% na.omit() 

# dat_nj_line <- dat_nj %>%
#   left_join(njlines, by = c('new_line_name_geo' = 'RAIL_LINE'))

dat_njstation <- dat_nj %>%
  left_join(njstations, by = c('from' = 'STATION'))

# dat_njstation_to <- dat_nj %>%
#   left_join(njstations, by = c('to' = 'STATION'))

nas <- dat_njstation %>%
  filter (is.na(COUNTY))
```

## Census Data
Collecting census data for States - New Jersey, New York and Pennsylvania
```{r get_census, message=FALSE, warning=FALSE, cache=TRUE}
census <- 
  get_acs(geography = "tract", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2018, 
          state = c("NJ",'NY','PA'),
          geometry = TRUE, 
          output = "wide") %>%
  rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E) %>%
  select(Total_Pop, Med_Inc, White_Pop, Travel_Time,
         Means_of_Transport, Total_Public_Trans,
         Med_Age,
         GEOID, geometry) %>%
  mutate(Percent_White = White_Pop / Total_Pop,
         Mean_Commute_Time = Travel_Time / Total_Public_Trans,
         Percent_Taking_Public_Trans = Total_Public_Trans / Means_of_Transport) %>% 
  st_transform('EPSG:2236')
```

```{r}
subset_census <- census[st_crop(census, st_bbox(njstations)),]

# mapview(st_bbox(census)) +
#   mapview(njstations, cex = 2) +
#   mapview(st_bbox(subset_census), col.regions = "orange")

```


```{r}
ggplot() +
  geom_sf(data = subset_census) +
  geom_sf(data = njstations %>% st_transform('EPSG:2236'), color = "blue") +
  mapTheme
```


## Weather Data
Collecting weather data for Trenton for the same duration as our original data set (March 2018). We make an assumption that overall weather patterns will remain similar throughout the states. For a more granular study it would make sense to include other location's weather data as well.

```{r import_weather, message = FALSE, warning = FALSE, cache = TRUE}
#Every hour
weather.Panel_hourly <- 
  riem_measures(station = "TTN", date_start = "2018-04-01", date_end = "2018-05-02") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))
glimpse(weather.Panel_hourly)
#Every day
weather.Panel_daily <- 
  riem_measures(station = "TTN", date_start = "2018-04-01", date_end = "2018-05-02") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(date(interval60)) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))
glimpse(weather.Panel_daily)
```

## Time-space Panel + Weather 

```{r}
dat_njstation$date <- as.Date(dat_njstation$date)
dat_njstation <- 
  dat_njstation %>%
  left_join(weather.Panel_daily, by = c('date' = 'date(interval60)'))
```

## Exploratory Data Analysis

### Weather Panel 

```{r}
grid.arrange(
  ggplot(weather.Panel_hourly, aes(interval60,Precipitation)) + geom_line() + 
  labs(title="Precipitation", x="Hour", y="Precipitation") + plotTheme,
  ggplot(weather.Panel_hourly, aes(interval60,Wind_Speed)) + geom_line() + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme,
  ggplot(weather.Panel_hourly, aes(interval60,Temperature)) + geom_line() + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme,
  top="Weather Data - Trenton TTN - March, 2018")
```

### Delay vs Precipitation (Daily)

```{r}
dat_njstation %>%
  group_by(date) %>% 
  summarize(delay_minutes = mean(delay_minutes, na.rm=T),
            Precipitation = first(Precipitation)) %>%
  mutate(isPrecip = ifelse(Precipitation > 0,"Rain/Snow", "None")) %>%
  group_by(isPrecip) %>%
  summarize(Mean_delay = mean(delay_minutes, na.rm=T)) %>%
    ggplot(aes(isPrecip, Mean_delay)) + geom_bar(stat = "identity") +
      labs(title="Does precipitation influence delay?",
           x="Precipitation", y="Mean Delay (Minutes)") +
      plotTheme
```

### Delay vs Windspeed (Daily)

```{r}
dat_njstation %>%
  group_by(date) %>% 
  summarize(delay_minutes = mean(delay_minutes, na.rm=T),
            Wind_Speed = first(Wind_Speed)) %>%
  mutate(isWind = ifelse(Wind_Speed > 20,"Windy", "None")) %>%
  group_by(isWind) %>%
  summarize(Mean_delay = mean(delay_minutes, na.rm=T)) %>%
    ggplot(aes(isWind, Mean_delay)) + geom_bar(stat = "identity") +
      labs(title="Does windspeed influence delay?",
           x="Windspeed", y="Mean Delay (Minutes)") +
      plotTheme
```

### Delay vs Temperature (Daily)
```{r}
dat_njstation %>%
  group_by(date) %>% 
  summarize(delay_minutes = mean(delay_minutes, na.rm=T),
            Temperature = first(Temperature)) %>%
  mutate(isHot = ifelse(Temperature > 60,"Hot", "None")) %>%
  group_by(isHot) %>%
  summarize(Mean_delay = mean(delay_minutes, na.rm=T)) %>%
    ggplot(aes(isHot, Mean_delay)) + geom_bar(stat = "identity") +
      labs(title="Does temperature influence delay?",
           x="Temperature", y="Mean Delay (Minutes)") +
      plotTheme
```

### Distribution of Total delay for different trains
```{r}
delay_train <- dat_njstation %>%
  mutate(date = as_date(scheduled_time)) %>%
  select(train_id, delay_minutes, date) %>%
  group_by(train_id, date) %>%
  summarize(total_delay = sum(delay_minutes))

ggplot(delay_train, aes(total_delay)) +
  geom_histogram()
```

```{r}
head(delay_train %>% filter(train_id=="0041") %>% arrange(date), 40)
```

```{r}
dat_njstation %>%
  filter(train_id == "0041", as_date(scheduled_time) == as_date("2018-03-02"))
```
### Distribution for Time of Day

### Distribution across Time and Space


## Feature Engineering
### Distance between Stations
```{r}

```

### Correlation plot for Continuous numeric features

## Building Model

### Split Data into Train and Test
```{r}
dat.Train <- filter(dat_njstation, week < 17)
dat.Test <- filter(dat_njstation, week >= 17)
```

```{r}
rbind(
  mutate(dat.Train, Legend = "Training"), 
  mutate(dat.Test, Legend = "Testing")) %>%
    group_by(Legend, interval60) %>% 
      summarize(Trip_Delay = mean(delay_minutes)) %>%
      ungroup() %>% 
      ggplot(aes(interval60, Trip_Delay, color = Legend)) + geom_line() +
        scale_colour_manual(values = palette2) +
        labs(title="Mean Delay across all train lines",
             x="Day", y="Trip Delay (minutes)") +
        plotTheme + theme(panel.grid.major = element_blank())
```

```{r}
dat_njstation %>%
  group_by(line, interval60) %>% 
  summarize(Trip_Delay = mean(delay_minutes)) %>%
  ungroup() %>% 
  ggplot(aes(interval60, Trip_Delay, color = line)) + geom_line() +
        #scale_colour_manual(values = palette2) +
  labs(title="Mean Delay across all train lines",
        x="Day", y="Trip Delay (minutes)") +
  plotTheme + theme(panel.grid.major = element_blank())
```

### Training model : First model
Trained using actual delay_minutes as the dependent variable.

```{r}
# reg1 <- 
#   lm(delay_minutes ~ train_id + dotw + Wind_Speed + Temperature + Precipitation, data = dat.Train)
# 
# summary(reg1)$r.squared
# summary(reg1)$adj.r.squared
```

```{r}
reg2 <- 
  lm(delay_minutes ~ from + to + dotw + train_id + Wind_Speed + Temperature + Precipitation,
     data = dat.Train)

summary(reg2)$r.squared
summary(reg2)$adj.r.squared
```

### Predicting for test data
We use nested data for the testing part. 

```{r nest_data, cache = TRUE, warning = FALSE, message = FALSE}
dat.Test.weekNest <- 
  dat.Test %>%
  nest(-week) 
```

When we run our predictions and summarize our results, we are going to have some NA data, which is due to the lag variables. 

```{r predict_function, cache = TRUE}
model_pred <- function(dat, fit){
   pred <- predict(fit, newdata = dat)}
```


```{r do_predicitons, cache = TRUE}
week_predictions <- 
  dat.Test.weekNest %>% 
    mutate(#ATime_FE = map(.x = data, fit = reg1, .f = model_pred),
           BSpace_FE = map(.x = data, fit = reg2, .f = model_pred),
           #CTime_Space_FE = map(.x = data, fit = reg3, .f = model_pred),
           #DTime_Space_FE_timeLags = map(.x = data, fit = reg4, .f = model_pred),
           #ETime_Space_FE_timeLags_holidayLags = map(.x = data, fit = reg5, .f = model_pred)
           ) %>% 
    gather(Regression, Prediction, -data, -week) %>%
    mutate(Observed = map(data, pull, delay_minutes),
           Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
           MAE = map_dbl(Absolute_Error, mean, na.rm = TRUE),
           sd_AE = map_dbl(Absolute_Error, sd, na.rm = TRUE))
week_predictions
```
### Cross validation

We perform cross validation (LOGO) across time by grouping them by the hours.  

```{r}
crossValidate <- function(dataset, id, dependentVariable, indVariables) {
  
  allPredictions <- data.frame()
  cvID_list <- unique(dataset[[id]])
  
  for (i in cvID_list) {
    
    thisFold <- i
    #cat("This hold out fold is", thisFold, "\n")
    
    fold.train <- filter(dataset, dataset[[id]] != thisFold) %>% as.data.frame() %>% 
      dplyr::select(indVariables, dependentVariable)
    fold.test  <- filter(dataset, dataset[[id]] == thisFold) %>% as.data.frame() %>% 
      dplyr::select(indVariables, dependentVariable)
    regression <-
      lm(delay_minutes ~ ., family = "poisson", data=fold.train)
    
    thisPrediction <- 
      mutate(fold.test, Prediction = predict(regression, fold.test, type = "response", na.action = na.pass))
    
    allPredictions <-
      rbind(allPredictions, thisPrediction)
    
  }
  return(allPredictions)
}
```

```{r }

find_na_rows <- function(data){
  M <- sapply(data, function(x) sum(is.na(x)));
  print(M[M>0][[1]])
}

#nas <- dat_njstation %>% filter (is.na(Temperature))

# find_na_rows(dat_njstation %>% select("dotw"))
# find_na_rows(dat_njstation %>% select("Temperature"))
# find_na_rows(dat_njstation %>% select("Precipitation"))
# find_na_rows(dat_njstation %>% select("delay_minutes"))
#find_na_rows(dat_njstation %>% select("dotw", "Temperature","Precipitation","delay_minutes"))
#print(nrow(dat_njstation %>% select("dotw", "Temperature","Precipitation","delay_minutes")))
```


```{r message=FALSE, warning=FALSE, results=F}
ind.vars <- c("dotw", "Temperature","Precipitation")

reg.cv <- crossValidate(
  dataset = dat_njstation,
  id = "dotw",
  dependentVariable = "delay_minutes",
  indVariables = ind.vars) %>%
  dplyr::select(delay_minutes, Prediction, dotw)
```

<!-- ### Training model : Second model -->

<!-- Trained using estimated delay as the dependent variable. -->
<!-- Where estimated delay = Actual time of travel - Scheduled time of travel, -->
<!-- Time of travel = Time recorded at destination station (from) - Time recorded at source station (to) -->


### Evaluation


There can be multiple factors causing delay. It is hard for us to be able to account for each. [NJ Transhit](https://njtranshit.com/excuses) provides a list of common and new excuses provided by rail authorities for delays. 